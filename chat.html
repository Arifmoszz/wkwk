<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global WhatsApp-like Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #e5ddd5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .chat-container {
            display: flex;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background-color: #fff;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .sidebar {
            width: 30%;
            min-width: 300px;
            border-right: 1px solid #e9edef;
            display: flex;
            flex-direction: column;
            background-color: #f0f2f5;
        }
        
        .sidebar-header {
            padding: 10px 16px;
            background-color: #f0f2f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #dfe5e7;
            color: #54656f;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
            font-size: 14px;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
        }
        
        .user-info span {
            font-weight: 500;
            font-size: 16px;
        }
        
        .user-info small {
            color: #667781;
            font-size: 12px;
        }
        
        .sidebar-actions {
            display: flex;
            gap: 10px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #54656f;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-btn:hover {
            background-color: #e9edef;
        }
        
        .search-bar {
            padding: 8px 12px;
            background-color: #f0f2f5;
            position: relative;
        }
        
        .search-bar input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background-color: #fff;
            font-size: 14px;
            outline: none;
        }
        
        .search-bar input:focus {
            box-shadow: 0 0 0 1px #00a884;
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            background-color: #fff;
        }
        
        .chat-item {
            display: flex;
            padding: 12px;
            gap: 12px;
            cursor: pointer;
            border-bottom: 1px solid #e9edef;
        }
        
        .chat-item:hover {
            background-color: #f5f6f6;
        }
        
        .chat-item.active {
            background-color: #f0f2f5;
        }
        
        .chat-item.unread {
            background-color: #f0f8ff;
        }
        
        .chat-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-name {
            font-weight: 500;
            font-size: 16px;
            color: #111b21;
        }
        
        .chat-preview {
            font-size: 14px;
            color: #667781;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            font-size: 12px;
            color: #667781;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #e5ddd5;
            background-image: url('https://web.whatsapp.com/img/bg-chat-tile-light_a4be512e7195b6b733d9110b408f075d.png');
            background-repeat: repeat;
        }
        
        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #41525d;
            text-align: center;
            padding: 20px;
        }
        
        .empty-chat-icon {
            margin-bottom: 20px;
        }
        
        .empty-chat h3 {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 16px;
        }
        
        .empty-chat p {
            font-size: 14px;
            color: #667781;
            max-width: 450px;
            line-height: 1.5;
        }
        
        .active-chat {
            flex: 1;
            display: none;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 10px 16px;
            background-color: #f0f2f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9edef;
        }
        
        .chat-partner {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .partner-info {
            display: flex;
            flex-direction: column;
        }
        
        .partner-info span {
            font-weight: 500;
            font-size: 16px;
        }
        
        .partner-info small {
            color: #667781;
            font-size: 12px;
        }
        
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .message {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.sent {
            background-color: #d9fdd3;
            align-self: flex-end;
            border-top-right-radius: 0;
        }
        
        .message.received {
            background-color: #fff;
            align-self: flex-start;
            border-top-left-radius: 0;
        }
        
        .message-content {
            font-size: 14px;
            color: #111b21;
        }
        
        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .message-time {
            font-size: 11px;
            color: #667781;
            text-align: right;
            margin-top: 4px;
        }
        
        .message-input {
            padding: 8px 12px;
            background-color: #f0f2f5;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .message-input input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            outline: none;
        }
        
        .emoji-btn, .send-btn, .attach-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #54656f;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-btn:hover, .send-btn:hover, .attach-btn:hover {
            background-color: #e9edef;
        }
        
        .send-btn {
            color: #00a884;
        }
        
        .search-results {
            position: absolute;
            width: calc(100% - 24px);
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            z-index: 100;
            margin-top: 5px;
            display: none;
        }
        
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-result-item:hover {
            background-color: #f5f6f6;
        }
        
        .new-chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            width: 400px;
            max-width: 90%;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px;
            background-color: #00a884;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-list-item {
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f0f2f5;
        }
        
        .user-list-item:hover {
            background-color: #f5f6f6;
        }
        
        .no-users {
            text-align: center;
            color: #667781;
            padding: 20px;
        }
        
        .country-flag {
            width: 20px;
            height: 15px;
            margin-right: 5px;
            border: 1px solid #ddd;
        }
        
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
        }
        
        .image-preview-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .close-preview {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .file-input {
            display: none;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            font-size: 12px;
            color: #667781;
        }
        
        .typing-dots {
            display: flex;
            gap: 2px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #667781;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .global-chat-badge {
            background-color: #25D366;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        .message-status {
            margin-left: 5px;
            font-size: 12px;
        }
        
        .message-status.sent {
            color: #667781;
        }
        
        .message-status.delivered {
            color: #4FC3F7;
        }
        
        .message-status.read {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="avatar" id="userAvatar"></div>
                    <div class="user-info">
                        <span id="currentUsername"></span>
                        <small id="userStatus">Online</small>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <button class="icon-btn" title="New chat" id="newChatBtn">
                        <svg viewBox="0 0 24 24" width="20" height="20">
                            <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                    </button>
                    <button class="icon-btn" title="Menu" id="menuBtn">
                        <svg viewBox="0 0 24 24" width="20" height="20">
                            <path fill="currentColor" d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search or start new chat">
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="chats-list" id="contacts">
                <!-- Contacts will be loaded here -->
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="empty-chat">
                <div class="empty-chat-icon">
                    <svg viewBox="0 0 24 24" width="120" height="120">
                        <path fill="#54656f" d="M19.005 3.175H4.674C3.642 3.175 3 3.789 3 4.821V21.02l3.544-3.514h12.461c1.033 0 2.064-1.06 2.064-2.093V4.821c-.001-1.032-1.032-1.646-2.064-1.646zm-4.989 9.869H7.041V11.1h6.975v1.944zm3-4H7.041V7.1h9.975v1.944z"/>
                    </svg>
                </div>
                <h3>Global Chat App</h3>
                <p>Select a chat to start messaging</p>
            </div>
            
            <div class="active-chat" style="display: none;">
                <div class="chat-header">
                    <div class="chat-partner">
                        <div class="avatar" id="chatPartnerAvatar"></div>
                        <div class="partner-info">
                            <span id="chatPartnerName"></span>
                            <small id="partnerStatus">Online</small>
                            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                                <span>typing</span>
                                <div class="typing-dots">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="icon-btn" title="Search">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                        </button>
                        <button class="icon-btn" title="Menu">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="currentColor" d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="messages" id="messages">
                    <!-- Messages will appear here -->
                </div>
                <div class="message-input">
                    <button class="attach-btn" title="Attach file" id="attachBtn">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                        </svg>
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept="image/*">
                    <button class="emoji-btn" title="Emoji" id="emojiBtn">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm0-2a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm-5-5h2a3 3 0 0 0 6 0h2a5 5 0 0 1-10 0zm1-2a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm8 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                        </svg>
                    </button>
                    <input type="text" id="messageInput" placeholder="Type a message...">
                    <button class="send-btn" id="sendBtn" title="Send">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div class="new-chat-modal" id="newChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Chat</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="userList">
                <!-- Users will be listed here -->
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="image-preview-modal" id="imagePreviewModal">
        <span class="close-preview">&times;</span>
        <div class="image-preview-content">
            <img id="previewImage" src="" alt="Preview">
        </div>
    </div>

    <script>
        // Check if user is logged in
        const currentUser = sessionStorage.getItem('currentUser');
        if (!currentUser) {
            window.location.href = 'index.html';
        }
        
        // Initialize user data
        document.getElementById('currentUsername').textContent = currentUser;
        document.getElementById('userAvatar').textContent = getInitials(currentUser);
        
        // Global chat simulation variables
        const globalUsers = [
            { name: "John Doe", country: "US", online: true },
            { name: "Maria Garcia", country: "ES", online: true },
            { name: "Ahmed Khan", country: "PK", online: false },
            { name: "Yuki Tanaka", country: "JP", online: true },
            { name: "LÃ©a Martin", country: "FR", online: false },
            { name: "Carlos Silva", country: "BR", online: true },
            { name: "Anna MÃ¼ller", country: "DE", online: true },
            { name: "David Wilson", country: "GB", online: false },
            { name: "Li Wei", country: "CN", online: true },
            { name: "Olga Ivanova", country: "RU", online: false }
        ];
        
        const countryFlags = {
            US: "ðŸ‡ºðŸ‡¸", ES: "ðŸ‡ªðŸ‡¸", PK: "ðŸ‡µðŸ‡°", JP: "ðŸ‡¯ðŸ‡µ", 
            FR: "ðŸ‡«ðŸ‡·", BR: "ðŸ‡§ðŸ‡·", DE: "ðŸ‡©ðŸ‡ª", GB: "ðŸ‡¬ðŸ‡§", 
            CN: "ðŸ‡¨ðŸ‡³", RU: "ðŸ‡·ðŸ‡º"
        };
        
        // Helper functions
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return formatTime(dateString);
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }
        
        // Simulate typing indicator
        function showTypingIndicator(contact) {
            if (document.getElementById('chatPartnerName').textContent === contact) {
                const typingIndicator = document.getElementById('typingIndicator');
                typingIndicator.style.display = 'flex';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                }, 3000);
            }
        }
        
        // Load contacts
        function loadContacts() {
            const contactsDiv = document.getElementById('contacts');
            const users = JSON.parse(localStorage.getItem('users')) || [];
            
            contactsDiv.innerHTML = '';
            
            // Add global chat option
            const globalChatItem = document.createElement('div');
            globalChatItem.className = 'chat-item';
            globalChatItem.innerHTML = `
                <div class="avatar">ðŸŒŽ</div>
                <div class="chat-info">
                    <span class="chat-name">Global Chat <span class="global-chat-badge">NEW</span></span>
                    <span class="chat-preview">Chat with people around the world</span>
                </div>
            `;
            globalChatItem.addEventListener('click', () => loadGlobalChat());
            contactsDiv.appendChild(globalChatItem);
            
            // Get all chats involving current user
            let chats = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`chat_${currentUser}_`) || key.startsWith(`chat_`) && key.endsWith(`_${currentUser}`)) {
                    const messages = JSON.parse(localStorage.getItem(key));
                    if (messages && messages.length > 0) {
                        const lastMessage = messages[messages.length - 1];
                        const participants = key.replace('chat_', '').split('_');
                        const otherUser = participants[0] === currentUser ? participants[1] : participants[0];
                        
                        // Check if we already have this chat
                        if (!chats.some(chat => chat.user === otherUser)) {
                            chats.push({
                                user: otherUser,
                                lastMessage: lastMessage.text || (lastMessage.image ? "ðŸ“· Photo" : ""),
                                timestamp: lastMessage.timestamp,
                                unread: key.startsWith(`chat_${currentUser}_`) ? false : messages.some(msg => !msg.read && msg.sender !== currentUser)
                            });
                        }
                    }
                }
            }
            
            // Sort chats by timestamp (newest first)
            chats.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Display chats
            chats.forEach(chat => {
                const contact = document.createElement('div');
                contact.className = `chat-item ${chat.unread ? 'unread' : ''}`;
                contact.innerHTML = `
                    <div class="avatar">${getInitials(chat.user)}</div>
                    <div class="chat-info">
                        <span class="chat-name">${chat.user}</span>
                        <span class="chat-preview">${chat.lastMessage}</span>
                    </div>
                    <div class="chat-time">${formatDate(chat.timestamp)}</div>
                `;
                contact.addEventListener('click', () => loadChat(chat.user));
                contactsDiv.appendChild(contact);
            });
            
            // Add other users who don't have chats yet
            users.forEach(user => {
                if (user !== currentUser && !chats.some(chat => chat.user === user)) {
                    const contact = document.createElement('div');
                    contact.className = 'chat-item';
                    contact.innerHTML = `
                        <div class="avatar">${getInitials(user)}</div>
                        <div class="chat-info">
                            <span class="chat-name">${user}</span>
                            <span class="chat-preview">No messages yet</span>
                        </div>
                    `;
                    contact.addEventListener('click', () => loadChat(user));
                    contactsDiv.appendChild(contact);
                }
            });
        }
        
        // Load global chat
        function loadGlobalChat() {
            document.querySelector('.empty-chat').style.display = 'none';
            document.querySelector('.active-chat').style.display = 'flex';
            
            document.getElementById('chatPartnerName').textContent = "Global Chat";
            document.getElementById('chatPartnerAvatar').textContent = "ðŸŒŽ";
            document.getElementById('partnerStatus').textContent = `${globalUsers.filter(u => u.online).length} online`;
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            
            // Load global messages
            const globalMessages = JSON.parse(localStorage.getItem('global_chat')) || [];
            
            globalMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = msg.sender === currentUser ? 'message sent' : 'message received';
                
                // Check if message is from a global user (not local storage user)
                const globalUser = globalUsers.find(u => u.name === msg.sender);
                const senderName = globalUser ? `${msg.sender} ${countryFlags[globalUser.country] || ''}` : msg.sender;
                
                if (msg.image) {
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div><strong>${senderName}</strong></div>
                            <img src="${msg.image}" class="message-image" onclick="showImagePreview('${msg.image}')">
                            ${msg.text ? `<div>${msg.text}</div>` : ''}
                        </div>
                        <div class="message-time">${formatTime(msg.timestamp)}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div><strong>${senderName}</strong></div>
                            <div>${msg.text}</div>
                        </div>
                        <div class="message-time">${formatTime(msg.timestamp)}</div>
                    `;
                }
                
                messagesDiv.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Focus on input
            document.getElementById('messageInput').focus();
        }
        
        // Load chat with a user
        function loadChat(contact) {
            document.querySelector('.empty-chat').style.display = 'none';
            document.querySelector('.active-chat').style.display = 'flex';
            
            document.getElementById('chatPartnerName').textContent = contact;
            document.getElementById('chatPartnerAvatar').textContent = getInitials(contact);
            
            // Check if this is a global user
            const globalUser = globalUsers.find(u => u.name === contact);
            if (globalUser) {
                document.getElementById('partnerStatus').textContent = globalUser.online ? "Online" : "Offline";
                document.getElementById('partnerStatus').innerHTML += ` ${countryFlags[globalUser.country] || ''}`;
            } else {
                document.getElementById('partnerStatus').textContent = "Online";
            }
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            
            const chatKey = `chat_${currentUser}_${contact}`;
            const messages = JSON.parse(localStorage.getItem(chatKey)) || [];
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = msg.sender === currentUser ? 'message sent' : 'message received';
                
                if (msg.image) {
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <img src="${msg.image}" class="message-image" onclick="showImagePreview('${msg.image}')">
                            ${msg.text ? `<div>${msg.text}</div>` : ''}
                        </div>
                        <div class="message-time">${formatTime(msg.timestamp)} 
                            ${msg.sender === currentUser ? 
                                `<span class="message-status ${msg.read ? 'read' : msg.delivered ? 'delivered' : 'sent'}">
                                    ${msg.read ? 'âœ“âœ“' : msg.delivered ? 'âœ“âœ“' : 'âœ“'}
                                </span>` : ''}
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-content">${msg.text}</div>
                        <div class="message-time">${formatTime(msg.timestamp)} 
                            ${msg.sender === currentUser ? 
                                `<span class="message-status ${msg.read ? 'read' : msg.delivered ? 'delivered' : 'sent'}">
                                    ${msg.read ? 'âœ“âœ“' : msg.delivered ? 'âœ“âœ“' : 'âœ“'}
                                </span>` : ''}
                        </div>
                    `;
                }
                
                messagesDiv.appendChild(messageDiv);
                
                // Mark as read if it's a received message
                if (msg.sender !== currentUser && !msg.read) {
                    msg.read = true;
                    localStorage.setItem(chatKey, JSON.stringify(messages));
                }
            });
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Focus on input
            document.getElementById('messageInput').focus();
            
            // Update contacts list
            loadContacts();
            
            // Simulate partner typing occasionally
            if (Math.random() > 0.7 && (globalUser?.online || !globalUser)) {
                setTimeout(() => {
                    showTypingIndicator(contact);
                    
                    // Simulate receiving a message after typing
                    setTimeout(() => {
                        if (document.getElementById('chatPartnerName').textContent === contact) {
                            receiveMessage(contact);
                        }
                    }, 3000);
                }, 2000);
            }
        }
        
        // Simulate receiving a message
        function receiveMessage(contact) {
            const isGlobalChat = contact === "Global Chat";
            const messagesDiv = document.getElementById('messages');
            
            const responses = [
                "Hello there!",
                "How are you doing?",
                "Nice to hear from you!",
                "I'm doing well, thanks for asking.",
                "What about you?",
                "Let's catch up soon!",
                "I was just thinking about you.",
                "Did you see the news today?",
                "How's your day going?",
                "ðŸ˜Š",
                "ðŸ‘",
                "Sounds good!"
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            const timestamp = new Date().toISOString();
            
            if (isGlobalChat) {
                // For global chat, simulate messages from random global users
                const randomUser = globalUsers[Math.floor(Math.random() * globalUsers.length)];
                const globalMessages = JSON.parse(localStorage.getItem('global_chat')) || [];
                
                // 30% chance of sending a photo in global chat
                const sendPhoto = Math.random() > 0.7;
                let imageUrl = '';
                
                if (sendPhoto) {
                    // Random placeholder image
                    const imageNum = Math.floor(Math.random() * 10) + 1;
                    imageUrl = `https://picsum.photos/id/${imageNum}00/300/200`;
                }
                
                const newMessage = {
                    sender: randomUser.name,
                    text: sendPhoto ? '' : randomResponse,
                    image: sendPhoto ? imageUrl : undefined,
                    timestamp,
                    country: randomUser.country
                };
                
                globalMessages.push(newMessage);
                localStorage.setItem('global_chat', JSON.stringify(globalMessages));
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message received';
                
                if (sendPhoto) {
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div><strong>${randomUser.name} ${countryFlags[randomUser.country] || ''}</strong></div>
                            <img src="${imageUrl}" class="message-image" onclick="showImagePreview('${imageUrl}')">
                            ${randomResponse ? `<div>${randomResponse}</div>` : ''}
                        </div>
                        <div class="message-time">${formatTime(timestamp)}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div><strong>${randomUser.name} ${countryFlags[randomUser.country] || ''}</strong></div>
                            <div>${randomResponse}</div>
                        </div>
                        <div class="message-time">${formatTime(timestamp)}</div>
                    `;
                }
                
                messagesDiv.appendChild(messageDiv);
            } else {
                // For private chat
                const chatKey1 = `chat_${contact}_${currentUser}`;
                const chatKey2 = `chat_${currentUser}_${contact}`;
                
                let messages1 = JSON.parse(localStorage.getItem(chatKey1)) || [];
                let messages2 = JSON.parse(localStorage.getItem(chatKey2)) || [];
                
                // 20% chance of sending a photo in private chat
                const sendPhoto = Math.random() > 0.8;
                let imageUrl = '';
                
                if (sendPhoto) {
                    // Random placeholder image
                    const imageNum = Math.floor(Math.random() * 10) + 1;
                    imageUrl = `https://picsum.photos/id/${imageNum}00/300/200`;
                }
                
                const newMessage = {
                    sender: contact,
                    text: sendPhoto ? '' : randomResponse,
                    image: sendPhoto ? imageUrl : undefined,
                    timestamp,
                    read: false
                };
                
                messages1.push(newMessage);
                messages2.push({...newMessage, read: true});
                
                localStorage.setItem(chatKey1, JSON.stringify(messages1));
                localStorage.setItem(chatKey2, JSON.stringify(messages2));
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message received';
                
                if (sendPhoto) {
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <img src="${imageUrl}" class="message-image" onclick="showImagePreview('${imageUrl}')">
                            ${randomResponse ? `<div>${randomResponse}</div>` : ''}
                        </div>
                        <div class="message-time">${formatTime(timestamp)}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-content">${randomResponse}</div>
                        <div class="message-time">${formatTime(timestamp)}</div>
                    `;
                }
                
                messagesDiv.appendChild(messageDiv);
            }
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Update contacts list
            loadContacts();
            
            // Show notification
            if (!document.hasFocus()) {
                showNotification(contact, sendPhoto ? "ðŸ“· Photo" : randomResponse);
            }
        }
        
        // Show desktop notification
        function showNotification(sender, message) {
            if (!("Notification" in window)) {
                return;
            }
            
            if (Notification.permission === "granted") {
                new Notification(`${sender}: ${message}`);
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(`${sender}: ${message}`);
                    }
                });
            }
        }
        
        // Send message
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        function sendMessage() {
            const contact = document.getElementById('chatPartnerName').textContent;
            if (!contact || contact === '') return;
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (!message) return;
            
            const isGlobalChat = contact === "Global Chat";
            const timestamp = new Date().toISOString();
            
            if (isGlobalChat) {
                // Handle global chat message
                const globalMessages = JSON.parse(localStorage.getItem('global_chat')) || [];
                globalMessages.push({
                    sender: currentUser,
                    text: message,
                    timestamp
                });
                localStorage.setItem('global_chat', JSON.stringify(globalMessages));
                
                // Display message
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                messageDiv.innerHTML = `
                    <div class="message-content">${message}</div>
                    <div class="message-time">${formatTime(timestamp)}</div>
                `;
                messagesDiv.appendChild(messageDiv);
            } else {
                // Handle private chat message
                const chatKey1 = `chat_${currentUser}_${contact}`;
                const chatKey2 = `chat_${contact}_${currentUser}`;
                
                // Save message in both directions
                let messages1 = JSON.parse(localStorage.getItem(chatKey1)) || [];
                messages1.push({ 
                    sender: currentUser, 
                    text: message, 
                    timestamp, 
                    read: true,
                    delivered: false // Will be updated when "received"
                });
                localStorage.setItem(chatKey1, JSON.stringify(messages1));
                
                let messages2 = JSON.parse(localStorage.getItem(chatKey2)) || [];
                messages2.push({ 
                    sender: currentUser, 
                    text: message, 
                    timestamp, 
                    read: false,
                    delivered: false
                });
                localStorage.setItem(chatKey2, JSON.stringify(messages2));
                
                // Display message
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                messageDiv.innerHTML = `
                    <div class="message-content">${message}</div>
                    <div class="message-time">${formatTime(timestamp)} 
                        <span class="message-status sent">âœ“</span>
                    </div>
                `;
                messagesDiv.appendChild(messageDiv);
                
                // Simulate message delivery and read status
                setTimeout(() => {
                    // Update delivery status
                    messages1[messages1.length - 1].delivered = true;
                    messages2[messages2.length - 1].delivered = true;
                    localStorage.setItem(chatKey1, JSON.stringify(messages1));
                    localStorage.setItem(chatKey2, JSON.stringify(messages2));
                    
                    // Update UI if we're still in this chat
                    if (document.getElementById('chatPartnerName').textContent === contact) {
                        const lastMessage = messagesDiv.querySelector('.message.sent:last-child .message-status');
                        if (lastMessage) {
                            lastMessage.className = 'message-status delivered';
                            lastMessage.innerHTML = 'âœ“âœ“';
                        }
                    }
                    
                    // Simulate read status after another delay
                    setTimeout(() => {
                        messages1[messages1.length - 1].read = true;
                        messages2[messages2.length - 1].read = true;
                        localStorage.setItem(chatKey1, JSON.stringify(messages1));
                        localStorage.setItem(chatKey2, JSON.stringify(messages2));
                        
                        if (document.getElementById('chatPartnerName').textContent === contact) {
                            const lastMessage = messagesDiv.querySelector('.message.sent:last-child .message-status');
                            if (lastMessage) {
                                lastMessage.className = 'message-status read';
                                lastMessage.innerHTML = 'âœ“âœ“';
                            }
                        }
                    }, 2000);
                }, 1000);
            }
            
            messageInput.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Update contacts list
            loadContacts();
            
            // Simulate response if this is a global user
            const globalUser = globalUsers.find(u => u.name === contact);
            if (globalUser && globalUser.online) {
                setTimeout(() => {
                    showTypingIndicator(contact);
                    
                    // Simulate receiving a message after typing
                    setTimeout(() => {
                        if (document.getElementById('chatPartnerName').textContent === contact) {
                            receiveMessage(contact);
                        }
                    }, 3000);
                }, 2000);
            }
        }
        
        // Handle file upload
        document.getElementById('attachBtn').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                alert('Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageUrl = event.target.result;
                sendImage(imageUrl);
            };
            reader.readAsDataURL(file);
        });
        
        function sendImage(imageUrl) {
            const contact = document.getElementById('chatPartnerName').textContent;
            if (!contact || contact === '') return;
            
            const isGlobalChat = contact === "Global Chat";
            const timestamp = new Date().toISOString();
            const messageInput = document.getElementById('messageInput');
            const caption = messageInput.value.trim();
            
            if (isGlobalChat) {
                // Handle global chat image
                const globalMessages = JSON.parse(localStorage.getItem('global_chat')) || [];
                globalMessages.push({
                    sender: currentUser,
                    text: caption,
                    image: imageUrl,
                    timestamp
                });
                localStorage.setItem('global_chat', JSON.stringify(globalMessages));
                
                // Display message
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <img src="${imageUrl}" class="message-image" onclick="showImagePreview('${imageUrl}')">
                        ${caption ? `<div>${caption}</div>` : ''}
                    </div>
                    <div class="message-time">${formatTime(timestamp)}</div>
                `;
                messagesDiv.appendChild(messageDiv);
            } else {
                // Handle private chat image
                const chatKey1 = `chat_${currentUser}_${contact}`;
                const chatKey2 = `chat_${contact}_${currentUser}`;
                
                // Save message in both directions
                let messages1 = JSON.parse(localStorage.getItem(chatKey1)) || [];
                messages1.push({ 
                    sender: currentUser, 
                    text: caption,
                    image: imageUrl,
                    timestamp, 
                    read: true,
                    delivered: false
                });
                localStorage.setItem(chatKey1, JSON.stringify(messages1));
                
                let messages2 = JSON.parse(localStorage.getItem(chatKey2)) || [];
                messages2.push({ 
                    sender: currentUser, 
                    text: caption,
                    image: imageUrl,
                    timestamp, 
                    read: false,
                    delivered: false
                });
                localStorage.setItem(chatKey2, JSON.stringify(messages2));
                
                // Display message
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <img src="${imageUrl}" class="message-image" onclick="showImagePreview('${imageUrl}')">
                        ${caption ? `<div>${caption}</div>` : ''}
                    </div>
                    <div class="message-time">${formatTime(timestamp)} 
                        <span class="message-status sent">âœ“</span>
                    </div>
                `;
                messagesDiv.appendChild(messageDiv);
                
                // Simulate message delivery and read status
                setTimeout(() => {
                    // Update delivery status
                    messages1[messages1.length - 1].delivered = true;
                    messages2[messages2.length - 1].delivered = true;
                    localStorage.setItem(chatKey1, JSON.stringify(messages1));
                    localStorage.setItem(chatKey2, JSON.stringify(messages2));
                    
                    // Update UI if we're still in this chat
                    if (document.getElementById('chatPartnerName').textContent === contact) {
                        const lastMessage = messagesDiv.querySelector('.message.sent:last-child .message-status');
                        if (lastMessage) {
                            lastMessage.className = 'message-status delivered';
                            lastMessage.innerHTML = 'âœ“âœ“';
                        }
                    }
                    
                    // Simulate read status after another delay
                    setTimeout(() => {
                        messages1[messages1.length - 1].read = true;
                        messages2[messages2.length - 1].read = true;
                        localStorage.setItem(chatKey1, JSON.stringify(messages1));
                        localStorage.setItem(chatKey2, JSON.stringify(messages2));
                        
                        if (document.getElementById('chatPartnerName').textContent === contact) {
                            const lastMessage = messagesDiv.querySelector('.message.sent:last-child .message-status');
                            if (lastMessage) {
                                lastMessage.className = 'message-status read';
                                lastMessage.innerHTML = 'âœ“âœ“';
                            }
                        }
                    }, 2000);
                }, 1000);
            }
            
            messageInput.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Update contacts list
            loadContacts();
            
            // Clear file input
            document.getElementById('fileInput').value = '';
            
            // Simulate response if this is a global user
            const globalUser = globalUsers.find(u => u.name === contact);
            if (globalUser && globalUser.online) {
                setTimeout(() => {
                    showTypingIndicator(contact);
                    
                    // Simulate receiving a message after typing
                    setTimeout(() => {
                        if (document.getElementById('chatPartnerName').textContent === contact) {
                            receiveMessage(contact);
                        }
                    }, 3000);
                }, 2000);
            }
        }
        
        // Show image preview
        window.showImagePreview = function(imageUrl) {
            const modal = document.getElementById('imagePreviewModal');
            const img = document.getElementById('previewImage');
            img.src = imageUrl;
            modal.style.display = 'flex';
        };
        
        // Close image preview
        document.querySelector('.close-preview').addEventListener('click', function() {
            document.getElementById('imagePreviewModal').style.display = 'none';
        });
        
        // Close image preview when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target === document.getElementById('imagePreviewModal')) {
                document.getElementById('imagePreviewModal').style.display = 'none';
            }
        });
        
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm.length === 0) {
                searchResults.style.display = 'none';
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const filteredUsers = users.filter(user => 
                user.toLowerCase().includes(searchTerm) && user !== currentUser
            );
            
            // Add global users to search results
            const filteredGlobalUsers = globalUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredUsers.length === 0 && filteredGlobalUsers.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No users found</div>';
                searchResults.style.display = 'block';
                return;
            }
            
            searchResults.innerHTML = '';
            
            // Add local users first
            filteredUsers.forEach(user => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.innerHTML = `
                    <div class="avatar">${getInitials(user)}</div>
                    <span>${user}</span>
                `;
                resultItem.addEventListener('click', () => {
                    loadChat(user);
                    searchResults.style.display = 'none';
                    e.target.value = '';
                });
                searchResults.appendChild(resultItem);
            });
            
            // Add global users
            filteredGlobalUsers.forEach(user => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.innerHTML = `
                    <div class="avatar">${getInitials(user.name)}</div>
                    <span>${user.name} ${countryFlags[user.country] || ''}</span>
                    <small style="margin-left: auto;">Global User</small>
                `;
                resultItem.addEventListener('click', () => {
                    loadChat(user.name);
                    searchResults.style.display = 'none';
                    e.target.value = '';
                });
                searchResults.appendChild(resultItem);
            });
            
            searchResults.style.display = 'block';
        });
        
        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-bar')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });
        
        // New chat modal
        document.getElementById('newChatBtn').addEventListener('click', function() {
            const modal = document.getElementById('newChatModal');
            const userList = document.getElementById('userList');
            
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const availableUsers = users.filter(u => u !== currentUser);
            
            if (availableUsers.length === 0 && globalUsers.length === 0) {
                userList.innerHTML = '<div class="no-users">No other users available</div>';
            } else {
                userList.innerHTML = '';
                
                // Add local users first
                availableUsers.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-list-item';
                    userItem.innerHTML = `
                        <div class="avatar">${getInitials(user)}</div>
                        <span>${user}</span>
                    `;
                    userItem.addEventListener('click', function() {
                        loadChat(user);
                        modal.style.display = 'none';
                    });
                    userList.appendChild(userItem);
                });
                
                // Add separator if we have both local and global users
                if (availableUsers.length > 0 && globalUsers.length > 0) {
                    const separator = document.createElement('div');
                    separator.style.padding = '10px';
                    separator.style.fontWeight = 'bold';
                    separator.style.borderBottom = '1px solid #f0f2f5';
                    separator.textContent = 'Global Users';
                    userList.appendChild(separator);
                }
                
                // Add global users
                globalUsers.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-list-item';
                    userItem.innerHTML = `
                        <div class="avatar">${getInitials(user.name)}</div>
                        <span>${user.name} ${countryFlags[user.country] || ''}</span>
                        <small style="margin-left: auto; color: ${user.online ? '#4CAF50' : '#666'}">
                            ${user.online ? 'Online' : 'Offline'}
                        </small>
                    `;
                    userItem.addEventListener('click', function() {
                        loadChat(user.name);
                        modal.style.display = 'none';
                    });
                    userList.appendChild(userItem);
                });
            }
            
            modal.style.display = 'flex';
        });
        
        document.getElementById('modalClose').addEventListener('click', function() {
            document.getElementById('newChatModal').style.display = 'none';
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target === document.getElementById('newChatModal')) {
                document.getElementById('newChatModal').style.display = 'none';
            }
        });
        
        // Request notification permission
        if ("Notification" in window) {
            Notification.requestPermission();
        }
        
        // Simulate global chat activity
        setInterval(() => {
            // 20% chance of a new global message appearing
            if (Math.random() > 0.8) {
                const globalMessages = JSON.parse(localStorage.getItem('global_chat')) || [];
                const lastMessage = globalMessages[globalMessages.length - 1];
                
                // Don't add new message if the last one was very recent
                if (!lastMessage || (new Date() - new Date(lastMessage.timestamp)) > 30000) {
                    const randomUser = globalUsers[Math.floor(Math.random() * globalUsers.length)];
                    
                    // 30% chance of sending a photo in global chat
                    const sendPhoto = Math.random() > 0.7;
                    let imageUrl = '';
                    
                    if (sendPhoto) {
                        // Random placeholder image
                        const imageNum = Math.floor(Math.random() * 10) + 1;
                        imageUrl = `https://picsum.photos/id/${imageNum}00/300/200`;
                    }
                    
                    const responses = [
                        "Hello everyone!",
                        "How's it going?",
                        "Anyone here from my country?",
                        "What's new?",
                        "Just checking in!",
                        "ðŸ˜Š",
                        "ðŸ‘",
                        "Have a great day!",
                        "Nice weather today!",
                        "What are you all up to?"
                    ];
                    
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    
                    const newMessage = {
                        sender: randomUser.name,
                        text: sendPhoto ? '' : randomResponse,
                        image: sendPhoto ? imageUrl : undefined,
                        timestamp: new Date().toISOString(),
                        country: randomUser.country
                    };
                    
                    globalMessages.push(newMessage);
                    localStorage.setItem('global_chat', JSON.stringify(globalMessages));
                    
                    // Update chat if we're in global chat view
                    if (document.getElementById('chatPartnerName').textContent === "Global Chat") {
                        const messagesDiv = document.getElementById('messages');
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message received';
                        
                        if (sendPhoto) {
                            messageDiv.innerHTML = `
                                <div class="message-content">
                                    <div><strong>${randomUser.name} ${countryFlags[randomUser.country] || ''}</strong></div>
                                    <img src="${imageUrl}" class="message-image" onclick="showImagePreview('${imageUrl}')">
                                    ${randomResponse ? `<div>${randomResponse}</div>` : ''}
                                </div>
                                <div class="message-time">${formatTime(newMessage.timestamp)}</div>
                            `;
                        } else {
                            messageDiv.innerHTML = `
                                <div class="message-content">
                                    <div><strong>${randomUser.name} ${countryFlags[randomUser.country] || ''}</strong></div>
                                    <div>${randomResponse}</div>
                                </div>
                                <div class="message-time">${formatTime(newMessage.timestamp)}</div>
                            `;
                        }
                        
                        messagesDiv.appendChild(messageDiv);
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                    
                    // Show notification if we're not in global chat
                    if (document.getElementById('chatPartnerName').textContent !== "Global Chat" && !document.hasFocus()) {
                        showNotification("Global Chat", sendPhoto ? "ðŸ“· New photo in global chat" : randomResponse);
                    }
                    
                    // Update contacts list to show new message in global chat
                    loadContacts();
                }
            }
        }, 10000); // Check every 10 seconds
        
        // Load contacts on page load
        window.addEventListener('load', function() {
            loadContacts();
            
            // Check if there's a chat to open from URL
            const urlParams = new URLSearchParams(window.location.search);
            const chatWith = urlParams.get('chat');
            if (chatWith) {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const globalUser = globalUsers.find(u => u.name === chatWith);
                
                if (users.includes(chatWith) || globalUser) {
                    loadChat(chatWith);
                } else if (chatWith === "Global Chat") {
                    loadGlobalChat();
                }
            }
        });
    </script>
</body>
</html>
